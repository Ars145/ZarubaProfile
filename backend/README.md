# ZARUBA Backend (Flask API)

Flask REST API –¥–ª—è ZARUBA Gaming Community Platform.

## üöÄ –ë—ã—Å—Ç—Ä—ã–π —Å—Ç–∞—Ä—Ç

### 1. –£—Å—Ç–∞–Ω–æ–≤–∫–∞ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–µ–π

```bash
cd backend
pip install -r requirements.txt
```

### 2. –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –æ–∫—Ä—É–∂–µ–Ω–∏—è

–°–æ–∑–¥–∞–π—Ç–µ —Ñ–∞–π–ª `.env` –≤ –∫–æ—Ä–Ω–µ –ø—Ä–æ–µ–∫—Ç–∞ (–Ω–µ –≤ –ø–∞–ø–∫–µ backend):

```env
# Flask
FLASK_ENV=development
SECRET_KEY=your-secret-key-here

# PostgreSQL (–ø–æ–ª—É—á–∏—Ç–µ —á–µ—Ä–µ–∑ Replit Database)
DATABASE_URL=postgresql://user:password@host:port/database

# MongoDB (SquadJS —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ - –æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ)
MONGO_URI=mongodb://user:password@host:port/
MONGO_DB_NAME=SquadJS
```

**–í–∞–∂–Ω–æ:** DATABASE_URL –º–æ–∂–Ω–æ –ø–æ–ª—É—á–∏—Ç—å —Å–æ–∑–¥–∞–≤ PostgreSQL –±–∞–∑—É –¥–∞–Ω–Ω—ã—Ö –≤ Replit:
- –û—Ç–∫—Ä–æ–π—Ç–µ –≤–∫–ª–∞–¥–∫—É "Tools" ‚Üí "Database"
- –°–æ–∑–¥–∞–π—Ç–µ PostgreSQL –±–∞–∑—É
- –°–∫–æ–ø–∏—Ä—É–π—Ç–µ DATABASE_URL

### 3. –ó–∞–ø—É—Å–∫ —Å–µ—Ä–≤–µ—Ä–∞

```bash
cd backend
python app.py
```

–°–µ—Ä–≤–µ—Ä –∑–∞–ø—É—Å—Ç–∏—Ç—Å—è –Ω–∞ `http://localhost:8000`

## üìä –°—Ö–µ–º–∞ –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö

### –¢–∞–±–ª–∏—Ü–∞: players
| –ü–æ–ª–µ | –¢–∏–ø | –û–ø–∏—Å–∞–Ω–∏–µ |
|------|-----|----------|
| id | UUID | Primary Key |
| steam_id | TEXT | Steam ID (—É–Ω–∏–∫–∞–ª—å–Ω—ã–π) |
| username | TEXT | –ò–≥—Ä–æ–≤–æ–µ –∏–º—è |
| discord_id | TEXT | Discord ID (nullable) |
| current_clan_id | UUID | FK ‚Üí clans.id |

### –¢–∞–±–ª–∏—Ü–∞: clans
| –ü–æ–ª–µ | –¢–∏–ø | –û–ø–∏—Å–∞–Ω–∏–µ |
|------|-----|----------|
| id | UUID | Primary Key |
| name | TEXT | –ù–∞–∑–≤–∞–Ω–∏–µ –∫–ª–∞–Ω–∞ |
| tag | TEXT | –¢–µ–≥ (—É–Ω–∏–∫–∞–ª—å–Ω—ã–π) |
| description | TEXT | –û–ø–∏—Å–∞–Ω–∏–µ |
| theme | TEXT | orange\|blue\|yellow |
| banner_url | TEXT | URL –±–∞–Ω–Ω–µ—Ä–∞ |
| logo_url | TEXT | URL –ª–æ–≥–æ—Ç–∏–ø–∞ |
| requirements | JSONB | –¢—Ä–µ–±–æ–≤–∞–Ω–∏—è |
| created_at | TIMESTAMP | –î–∞—Ç–∞ —Å–æ–∑–¥–∞–Ω–∏—è |

### –¢–∞–±–ª–∏—Ü–∞: clan_members
| –ü–æ–ª–µ | –¢–∏–ø | –û–ø–∏—Å–∞–Ω–∏–µ |
|------|-----|----------|
| id | UUID | Primary Key |
| clan_id | UUID | FK ‚Üí clans.id (CASCADE) |
| player_id | UUID | FK ‚Üí players.id (CASCADE) |
| role | TEXT | owner\|member |
| stats_snapshot | JSONB | –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ |
| joined_at | TIMESTAMP | –î–∞—Ç–∞ –≤—Å—Ç—É–ø–ª–µ–Ω–∏—è |

**Constraint:** UNIQUE(clan_id, player_id)

### –¢–∞–±–ª–∏—Ü–∞: clan_applications
| –ü–æ–ª–µ | –¢–∏–ø | –û–ø–∏—Å–∞–Ω–∏–µ |
|------|-----|----------|
| id | UUID | Primary Key |
| clan_id | UUID | FK ‚Üí clans.id (CASCADE) |
| player_name | TEXT | –ò–º—è –∏–≥—Ä–æ–∫–∞ |
| player_steam_id | TEXT | Steam ID |
| message | TEXT | –°–æ–æ–±—â–µ–Ω–∏–µ |
| status | TEXT | pending\|accepted\|rejected |
| stats_snapshot | JSONB | –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ |
| created_at | TIMESTAMP | –î–∞—Ç–∞ –ø–æ–¥–∞—á–∏ |

## üîå API Endpoints

### –ö–ª–∞–Ω—ã

**–ü–æ–ª—É—á–∏—Ç—å –≤—Å–µ –∫–ª–∞–Ω—ã:**
```http
GET /api/clans
```

**–ü–æ–ª—É—á–∏—Ç—å –∫–ª–∞–Ω –ø–æ ID:**
```http
GET /api/clans/:id
```

**–°–æ–∑–¥–∞—Ç—å –∫–ª–∞–Ω:**
```http
POST /api/clans
Content-Type: application/json

{
  "name": "–ù–∞–∑–≤–∞–Ω–∏–µ –∫–ª–∞–Ω–∞",
  "tag": "TAG",
  "description": "–û–ø–∏—Å–∞–Ω–∏–µ",
  "theme": "orange",
  "requirements": {
    "minKD": 1.5,
    "minHours": 100
  }
}
```

**–û–±–Ω–æ–≤–∏—Ç—å –∫–ª–∞–Ω:**
```http
PUT /api/clans/:id
Content-Type: application/json

{
  "name": "–ù–æ–≤–æ–µ –Ω–∞–∑–≤–∞–Ω–∏–µ",
  "description": "–ù–æ–≤–æ–µ –æ–ø–∏—Å–∞–Ω–∏–µ"
}
```

**–£–¥–∞–ª–∏—Ç—å –∫–ª–∞–Ω:**
```http
DELETE /api/clans/:id
```

**–ü–æ–ª—É—á–∏—Ç—å —É—á–∞—Å—Ç–Ω–∏–∫–æ–≤ –∫–ª–∞–Ω–∞:**
```http
GET /api/clans/:id/members
```

## üìÅ –°—Ç—Ä—É–∫—Ç—É—Ä–∞ –ø—Ä–æ–µ–∫—Ç–∞

```
backend/
‚îú‚îÄ‚îÄ app.py                 # –¢–æ—á–∫–∞ –≤—Ö–æ–¥–∞ Flask
‚îú‚îÄ‚îÄ config.py              # –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è
‚îú‚îÄ‚îÄ requirements.txt       # –ó–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏
‚îú‚îÄ‚îÄ .env.example          # –ü—Ä–∏–º–µ—Ä .env —Ñ–∞–π–ª–∞
‚îÇ
‚îú‚îÄ‚îÄ models/                # SQLAlchemy –º–æ–¥–µ–ª–∏
‚îÇ   ‚îú‚îÄ‚îÄ __init__.py
‚îÇ   ‚îú‚îÄ‚îÄ player.py
‚îÇ   ‚îú‚îÄ‚îÄ clan.py
‚îÇ   ‚îú‚îÄ‚îÄ clan_member.py
‚îÇ   ‚îî‚îÄ‚îÄ clan_application.py
‚îÇ
‚îú‚îÄ‚îÄ routes/                # API –º–∞—Ä—à—Ä—É—Ç—ã
‚îÇ   ‚îú‚îÄ‚îÄ __init__.py
‚îÇ   ‚îî‚îÄ‚îÄ clans.py
‚îÇ
‚îú‚îÄ‚îÄ services/              # –ë–∏–∑–Ω–µ—Å-–ª–æ–≥–∏–∫–∞ (–±—É–¥–µ—Ç –¥–æ–±–∞–≤–ª–µ–Ω–æ)
‚îú‚îÄ‚îÄ utils/                 # –£—Ç–∏–ª–∏—Ç—ã (–±—É–¥–µ—Ç –¥–æ–±–∞–≤–ª–µ–Ω–æ)
‚îî‚îÄ‚îÄ data/                  # –ù–µ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è (PostgreSQL)
```

## üõ† –†–∞–∑—Ä–∞–±–æ—Ç–∫–∞

### –°–æ–∑–¥–∞–Ω–∏–µ –º–∏–≥—Ä–∞—Ü–∏–π

–ü—Ä–∏ –∏–∑–º–µ–Ω–µ–Ω–∏–∏ –º–æ–¥–µ–ª–µ–π —Ç–∞–±–ª–∏—Ü—ã —Å–æ–∑–¥–∞—é—Ç—Å—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –ø—Ä–∏ –∑–∞–ø—É—Å–∫–µ —á–µ—Ä–µ–∑ `db.create_all()`.

–î–ª—è production —Ä–µ–∫–æ–º–µ–Ω–¥—É–µ—Ç—Å—è –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å Alembic –¥–ª—è –º–∏–≥—Ä–∞—Ü–∏–π.

### CORS

CORS –Ω–∞—Å—Ç—Ä–æ–µ–Ω –¥–ª—è –≤—Å–µ—Ö origins –Ω–∞ `/api/*` –º–∞—Ä—à—Ä—É—Ç–∞—Ö –¥–ª—è —É–ø—Ä–æ—â–µ–Ω–∏—è —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–∏.
–í production —Å–ª–µ–¥—É–µ—Ç –æ–≥—Ä–∞–Ω–∏—á–∏—Ç—å —Å–ø–∏—Å–æ–∫ —Ä–∞–∑—Ä–µ—à–µ–Ω–Ω—ã—Ö origins.

## üîí –ë–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å

- ‚ö†Ô∏è –ò–∑–º–µ–Ω–∏—Ç–µ `SECRET_KEY` –≤ production
- ‚ö†Ô∏è –ù–∞—Å—Ç—Ä–æ–π—Ç–µ CORS –¥–ª—è –∫–æ–Ω–∫—Ä–µ—Ç–Ω—ã—Ö –¥–æ–º–µ–Ω–æ–≤ –≤ production
- ‚ö†Ô∏è –ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –æ–∫—Ä—É–∂–µ–Ω–∏—è –¥–ª—è –≤—Å–µ—Ö —Å–µ–∫—Ä–µ—Ç–æ–≤

## üöÄ Production

–î–ª—è production –∏—Å–ø–æ–ª—å–∑—É–π—Ç–µ Gunicorn:

```bash
gunicorn -w 4 -b 0.0.0.0:8000 app:app
```

## ‚úÖ –°—Ç–∞—Ç—É—Å

**–†–µ–∞–ª–∏–∑–æ–≤–∞–Ω–æ:**
- ‚úÖ PostgreSQL –º–æ–¥–µ–ª–∏ (SQLAlchemy) - –∫–ª–∞–Ω—ã, –∏–≥—Ä–æ–∫–∏, —É—á–∞—Å—Ç–Ω–∏–∫–∏, –∑–∞—è–≤–∫–∏
- ‚úÖ CRUD —ç–Ω–¥–ø–æ–∏–Ω—Ç—ã –¥–ª—è –∫–ª–∞–Ω–æ–≤
- ‚úÖ MongoDB –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è –¥–ª—è —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏ Squad (SquadJS)
- ‚úÖ API endpoints –¥–ª—è —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏ –∏–≥—Ä–æ–∫–æ–≤
- ‚úÖ –ü–æ—Ä—Ç–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ —Ä–∞—Å—á—ë—Ç—ã –∏–∑ Discord –±–æ—Ç–∞ (—Ç–µ—Ö–Ω–∏–∫–∞, –æ—Ä—É–∂–∏–µ, —Ä–∞–Ω–≥–∏)
- ‚úÖ CORS –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è
- ‚úÖ Graceful degradation (—Ä–∞–±–æ—Ç–∞–µ—Ç –±–µ–∑ MongoDB)

**–í —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–µ:**
- üöß –ê—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏—è (Steam/Discord OAuth)
- üöß –ó–∞–≥—Ä—É–∑–∫–∞ —Ñ–∞–π–ª–æ–≤ (–∞–≤–∞—Ç–∞—Ä—ã, –ª–æ–≥–æ—Ç–∏–ø—ã –∫–ª–∞–Ω–æ–≤)
- üöß –≠–Ω–¥–ø–æ–∏–Ω—Ç—ã –¥–ª—è –∑–∞—è–≤–æ–∫ –≤ –∫–ª–∞–Ω—ã
- üöß –≠–Ω–¥–ø–æ–∏–Ω—Ç—ã –¥–ª—è –∏–≥—Ä–æ–∫–æ–≤ (—Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è, –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ)

### –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –∏–≥—Ä–æ–∫–æ–≤

**–ü–æ–ª—É—á–∏—Ç—å —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É –ø–æ Steam ID:**
```http
GET /api/stats/:steamId
```

–û—Ç–≤–µ—Ç:
```json
{
  "success": true,
  "stats": {
    "steamId": "76561198000000000",
    "playerName": "Player",
    "kills": 1500,
    "deaths": 800,
    "kd": 1.88,
    "matches": 250,
    "wins": 120,
    "winRate": 48.0,
    "playtime": "150—á",
    "heavyVehicleTime": "45—á",
    "heliTime": "12—á",
    "vehicleKills": 320,
    "topWeapons": [
      {"name": "M4A1", "kills": 450},
      {"name": "M240", "kills": 200}
    ],
    "topRoles": [
      {"name": "Rifleman", "time": "80—á", "minutes": 4800}
    ],
    "rank": {
      "groupId": "2",
      "score": 15000
    }
  }
}
```

**–ü–æ–∏—Å–∫ –∏–≥—Ä–æ–∫–∞ –ø–æ –∏–º–µ–Ω–∏:**
```http
GET /api/stats/search/:playerName
```

**–¢–∞–±–ª–∏—Ü–∞ –ª–∏–¥–µ—Ä–æ–≤:**
```http
GET /api/stats/leaderboard?sortBy=kills&limit=10
```

–ü–∞—Ä–∞–º–µ—Ç—Ä—ã:
- `sortBy`: kills (default), kd, matches, wins
- `limit`: –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –∏–≥—Ä–æ–∫–æ–≤ (max 50, default 10)

**–ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è —Ä–∞–Ω–≥–æ–≤:**
```http
GET /api/stats/ranks
```

## üîå MongoDB –°—Ç—Ä—É–∫—Ç—É—Ä–∞

### –ë–∞–∑–∞ –¥–∞–Ω–Ω—ã—Ö: SquadJS

**–ö–æ–ª–ª–µ–∫—Ü–∏—è: mainstats**
–°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –∏–≥—Ä–æ–∫–æ–≤ Squad:
- `_id`: Steam ID –∏–≥—Ä–æ–∫–∞
- `playerName`: –ò–º—è –∏–≥—Ä–æ–∫–∞
- `kills`, `deaths`: –£–±–∏–π—Å—Ç–≤–∞/—Å–º–µ—Ä—Ç–∏
- `matches`, `wins`: –ú–∞—Ç—á–∏/–ø–æ–±–µ–¥—ã
- `time`: –í—Ä–µ–º—è –∏–≥—Ä—ã (–º–∏–Ω—É—Ç—ã)
- `commanderTime`, `squadLeadTime`: –í—Ä–µ–º—è –≤ —Ä–æ–ª–∏
- `possess`: –í—Ä–µ–º—è –≤–ª–∞–¥–µ–Ω–∏—è —Ç–µ—Ö–Ω–∏–∫–æ–π (–º—Å)
- `weapons`: –£–±–∏–π—Å—Ç–≤–∞ –ø–æ –æ—Ä—É–∂–∏—é
- `roles`: –í—Ä–µ–º—è –≤ —Ä–æ–ª—è—Ö (–º–∏–Ω—É—Ç—ã)
- `scoreGroups`: –û—á–∫–∏ –ø–æ –≥—Ä—É–ø–ø–∞–º –¥–ª—è —Ä–∞–Ω–≥–æ–≤–æ–π —Å–∏—Å—Ç–µ–º—ã

**–ö–æ–ª–ª–µ–∫—Ü–∏—è: configs**
–ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è —Å–∏—Å—Ç–µ–º—ã —Ä–∞–Ω–≥–æ–≤:
- `type`: "score"
- `icons`: –ì—Ä—É–ø–ø—ã —Ä–∞–Ω–≥–æ–≤ —Å —Ç—Ä–µ–±–æ–≤–∞–Ω–∏—è–º–∏

## üìö –ü–æ—Ä—Ç–∏—Ä–æ–≤–∞–Ω–Ω–∞—è –ª–æ–≥–∏–∫–∞

–ò–∑ Discord –±–æ—Ç–∞ (JavaScript ‚Üí Python):

‚úÖ **–†–∞—Å—á—ë—Ç—ã –≤—Ä–µ–º–µ–Ω–∏:**
- –¢—è–∂—ë–ª–∞—è —Ç–µ—Ö–Ω–∏–∫–∞ (—Ç–∞–Ω–∫–∏, –ë–ú–ü, –ë–¢–†)
- –í–µ—Ä—Ç–æ–ª—ë—Ç—ã
- –§–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –≤—Ä–µ–º–µ–Ω–∏ (–¥–Ω–∏, —á–∞—Å—ã, –º–∏–Ω—É—Ç—ã)

‚úÖ **–†–∞—Å—á—ë—Ç—ã —É–±–∏–π—Å—Ç–≤:**
- –£–±–∏–π—Å—Ç–≤–∞ –∏–∑ —Ç–µ—Ö–Ω–∏–∫–∏ (–ø–æ –æ—Ä—É–∂–∏—é)
- –ö–∞—Ç–µ–≥–æ—Ä–∏–∑–∞—Ü–∏—è –æ—Ä—É–∂–∏—è (–∞—Ä—Ç–∏–ª–ª–µ—Ä–∏—è, –Ω–æ–∂–∏)

‚úÖ **–†–∞–Ω–≥–æ–≤–∞—è —Å–∏—Å—Ç–µ–º–∞:**
- –ü–æ–ª—É—á–µ–Ω–∏–µ –≤—ã—Å—à–µ–≥–æ —Ä–∞–Ω–≥–∞ –∏–≥—Ä–æ–∫–∞
- –ü—Ä–æ–≥—Ä–µ—Å—Å –¥–æ —Å–ª–µ–¥—É—é—â–µ–≥–æ —Ä–∞–Ω–≥–∞

## üìù –ü—Ä–∏–º–µ—á–∞–Ω–∏—è

- **MongoDB –æ–ø—Ü–∏–æ–Ω–∞–ª–µ–Ω**: API —Ä–∞–±–æ—Ç–∞–µ—Ç –±–µ–∑ MongoDB, –≤–æ–∑–≤—Ä–∞—â–∞—è 503 –¥–ª—è stats endpoints
- **Graceful degradation**: PostgreSQL endpoints —Ä–∞–±–æ—Ç–∞—é—Ç –Ω–µ–∑–∞–≤–∏—Å–∏–º–æ –æ—Ç MongoDB
- **Production**: –î–ª—è production –∏—Å–ø–æ–ª—å–∑—É–π—Ç–µ Gunicorn –≤–º–µ—Å—Ç–æ Flask dev server
- **–ë–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å**: MONGO_URI –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å –≤ environment variables, –Ω–µ –≤ –∫–æ–¥–µ
